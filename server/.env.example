# Server Environment Setup Guide

**Last Updated:** January 18, 2026

---

## .env Configuration

Copy this template to `.env` in the server root directory and fill in your actual values.

```env
# ========== DATABASE ==========
MONGO_URI=mongodb+srv://username:password@cluster.mongodb.net/invento-db?retryWrites=true&w=majority

# ========== JWT CONFIGURATION ==========
# Use a strong random string (minimum 32 characters)
# Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=your-super-secret-jwt-key-minimum-32-characters-long-change-this

# JWT token expiry (examples: "7d", "24h", "7200")
JWT_EXPIRY=7d

# ========== FIREBASE CONFIGURATION ==========
# Get these from Firebase Console > Project Settings > Service Account
FIREBASE_PROJECT_ID=your-firebase-project-id
FIREBASE_PRIVATE_KEY_ID=your-private-key-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQE...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com
FIREBASE_CLIENT_ID=123456789

# ========== EMAIL CONFIGURATION ==========
# For Gmail: Use App Passwords (not your main password)
# https://myaccount.google.com/apppasswords
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-specific-password

# ========== SERVER CONFIGURATION ==========
# Server port
PORT=5000

# Environment: development | staging | production
NODE_ENV=development

# Logging level: error | warn | info | debug
LOG_LEVEL=info

# ========== SECURITY CONFIGURATION ==========
# Comma-separated list of allowed frontend origins
# Development:
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000

# Production (example):
# ALLOWED_ORIGINS=https://app.invento2026.com,https://staging.invento2026.com
```

---

## Setup Instructions

### 1. Copy Template
```bash
cd server
cp .env.example .env
# Or create new file:
touch .env
```

### 2. Generate JWT Secret
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```
Copy the output and paste it as `JWT_SECRET` value.

### 3. Firebase Setup

1. Go to [Firebase Console](https://console.firebase.google.com)
2. Select your project
3. Go to **Project Settings** > **Service Accounts**
4. Click **Generate New Private Key**
5. Copy the JSON content and extract:
   - `project_id` → `FIREBASE_PROJECT_ID`
   - `private_key_id` → `FIREBASE_PRIVATE_KEY_ID`
   - `private_key` → `FIREBASE_PRIVATE_KEY`
   - `client_email` → `FIREBASE_CLIENT_EMAIL`
   - `client_id` → `FIREBASE_CLIENT_ID`

**Important:** The `private_key` contains literal `\n` characters. Make sure to preserve them:
```
# Correct:
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQE...\n-----END PRIVATE KEY-----\n"

# Incorrect (missing \n):
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQE...
-----END PRIVATE KEY-----"
```

### 4. MongoDB Setup

1. Create a MongoDB Atlas cluster (or use local MongoDB)
2. Get connection string
3. Add username/password
4. Update `MONGO_URI`

**Example MongoDB Atlas connection:**
```
mongodb+srv://username:password@cluster0.abc123.mongodb.net/invento-db?retryWrites=true&w=majority
```

### 5. Email Configuration

#### Using Gmail with App Passwords:
1. Enable 2-Factor Authentication on your Gmail account
2. Go to [App Passwords](https://myaccount.google.com/apppasswords)
3. Select "Mail" and "Windows Computer" (or your device)
4. Generate App Password
5. Copy the generated password (will be 16 characters)
6. Set `EMAIL_USER` and `EMAIL_PASSWORD`

#### Using Other Email Services:
Replace SMTP configuration as needed. Current setup uses Nodemailer for Gmail.

### 6. CORS Configuration

**For Development:**
```env
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000
```

**For Production:**
```env
ALLOWED_ORIGINS=https://app.invento2026.com,https://staging.invento2026.com
```

---

## Validation

When you start the server, it will automatically validate all environment variables:

```bash
npm run dev
```

Expected output:
```
============================================================
[STARTUP] Environment Configuration
============================================================
  NODE_ENV: development
  PORT: 5000
  JWT_EXPIRY: 7d
  LOG_LEVEL: info
  MONGO_URI: mongodb+srv://user***password@cluster.mongodb.net/db
  JWT_SECRET_LENGTH: 64
  FIREBASE_PROJECT_ID: my-project
  EMAIL_USER: noreply@invento.com
  ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173
============================================================
```

### Common Validation Errors

| Error | Solution |
|-------|----------|
| `Missing required environment variables: MONGO_URI, ...` | Add missing variables to `.env` |
| `JWT_SECRET must be at least 32 characters` | Generate new secret using provided command |
| `Invalid URLs in ALLOWED_ORIGINS` | Use valid URLs (http:// or https://) |
| `FIREBASE_PRIVATE_KEY appears to be malformed` | Ensure key has `-----BEGIN PRIVATE KEY-----` header |
| `EMAIL_USER appears to be invalid` | Check email format (user@domain.com) |

---

## Security Notes

### ⚠️ Important

1. **Never commit `.env` file** to version control
2. **Never share `JWT_SECRET`** with anyone
3. **Never expose `FIREBASE_PRIVATE_KEY`** publicly
4. **Update `ALLOWED_ORIGINS`** for each environment
5. **Rotate `JWT_SECRET`** periodically
6. **Use strong passwords** for MongoDB and email

### File Permissions

```bash
# Make .env readable only by owner (Linux/Mac)
chmod 600 .env

# Verify
ls -la .env
# Should show: -rw------- (only owner can read)
```

---

## Quick Start

```bash
# 1. Navigate to server directory
cd server

# 2. Create and configure .env
cp .env.example .env
# Edit .env with your values

# 3. Install dependencies
npm install

# 4. Start development server
npm run dev

# Expected output:
# ============================================================
# [STARTUP] Environment Configuration
# ============================================================
# [AUTH] Server running on port 5000
```

---

## Troubleshooting

### Server won't start

**Check 1:** All environment variables set
```bash
node -e "require('dotenv').config(); console.log(process.env.JWT_SECRET ? 'JWT_SECRET set' : 'JWT_SECRET missing')"
```

**Check 2:** MongoDB connection
```bash
node -e "const mongoose = require('mongoose'); mongoose.connect(process.env.MONGO_URI).then(() => console.log('✓ MongoDB connected')).catch(e => console.log('✗ MongoDB error:', e.message))"
```

**Check 3:** Firebase configuration
```bash
node -e "const admin = require('firebase-admin'); console.log(admin.credential ? '✓ Firebase ready' : '✗ Firebase not configured')"
```

### Connection errors

- ✅ Check internet connection
- ✅ Verify database connection string
- ✅ Check firewall/network settings
- ✅ Verify credentials are correct

---

## Production Deployment

### Pre-Deployment Checklist

```bash
# 1. Update NODE_ENV
NODE_ENV=production

# 2. Use strong JWT_SECRET (minimum 32 chars)
JWT_SECRET=<generate-new-random-secret>

# 3. Update ALLOWED_ORIGINS
ALLOWED_ORIGINS=https://yourdomain.com

# 4. Use production MongoDB
MONGO_URI=<your-production-connection>

# 5. Use production email service
EMAIL_USER=noreply@yourdomain.com
EMAIL_PASSWORD=<production-password>

# 6. Verify all variables
npm run dev  # Should show [STARTUP] configuration
```

### Environment Variables to Change

| Variable | Development | Production |
|----------|------------|-----------|
| NODE_ENV | development | production |
| PORT | 5000 | 3000 or 8080 |
| LOG_LEVEL | info | warn |
| ALLOWED_ORIGINS | localhost | yourdomain.com |
| MONGO_URI | local or test | production cluster |

---

**For more information, see:** [SECURITY_IMPLEMENTATION.md](./SECURITY_IMPLEMENTATION.md)
